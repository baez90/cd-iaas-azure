pool:
  vmImage: ubuntu-16.04

steps:
- task: DotNetCoreInstaller@0
  displayName: 'Use .NET Core sdk 2.2.103'
  inputs:
    version: 2.2.103
- bash: |
    ./build.sh
  displayName: Cake build
- bash: |
    ./build.sh --target="Publish"
  displayName: Publish

- task: PublishBuildArtifacts@1
  inputs:
    artifactName: 'dist'
    pathtoPublish: './dist'

- task: riezebosch.Packer.PackerTool.PackerTool@0
  displayName: 'Use Packer 1.3.4'
  inputs:
    version: 1.3.4

- task: riezebosch.Packer.Packer.Packer@1
  displayName: 'Packer build'
  inputs:
    azureSubscription: 'Microsoft Azure FHR infca (8f5caaee-a2d8-4d9a-a89c-f065af38e8c1)'
    templatePath: deploy/packer/Hackerthon.json
    variables: 'image_name=Hackathon-$(Build.BuildId)'

- task: tylerevert.Vsts-Release-Terraform.Vsts-Release-Terraform.Terraform@1
  displayName: 'Terraform plan'
  inputs:
    TemplatePath: deploy/terraform
    Arguments: plan -out=tfplan
    InstallTerraform: true
    ManageState: true
    ConnectedServiceNameARM: 'Microsoft Azure FHR infca (8f5caaee-a2d8-4d9a-a89c-f065af38e8c1)'
    StorageAccountRM: cdiaastfstate
    StorageContainerName: tfstate

- task: tylerevert.Vsts-Release-Terraform.Vsts-Release-Terraform.Terraform@1
  displayName: 'Terraform apply'
  inputs:
    TemplatePath: deploy/terraform
    Arguments: 'apply ./tfplan'
    ManageState: true
    ConnectedServiceNameARM: 'Microsoft Azure FHR infca (8f5caaee-a2d8-4d9a-a89c-f065af38e8c1)'
    StorageAccountRM: cdiaastfstate
    StorageContainerName: tfstate
