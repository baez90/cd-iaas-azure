pool:
  vmImage: ubuntu-16.04

steps:
- task: DotNetCoreInstaller@0
  displayName: 'Use .NET Core sdk 2.2.103'
  inputs:
    version: 2.2.103
- bash: |
    ./build.sh
  displayName: Cake build
- bash: |
    ./build.sh --target="Publish"
  displayName: Publish

- task: PublishBuildArtifacts@1
  inputs:
    artifactName: 'dist'
    pathtoPublish: './dist'

- task: riezebosch.Packer.PackerTool.PackerTool@0
  displayName: 'Use Packer 1.3.4'
  inputs:
    version: 1.3.4

- task: riezebosch.Packer.Packer.Packer@1
  displayName: 'Packer build'
  inputs:
    azureSubscription: 'Microsoft Azure FHR infca (8f5caaee-a2d8-4d9a-a89c-f065af38e8c1)'
    templatePath: deploy/packer/Hackerthon.json
    variables: 'image_name=Hackathon-$(Build.BuildId)'

- task: petergroenewegen.PeterGroenewegen-Xpirit-Vsts-Release-Terraform.Xpirit-Vsts-Release-Terraform.Terraform@2
  displayName: 'Terraform plan -var "immutable_image_name=Hackathon-$(Build.BuildId)"'
  inputs:
    TemplatePath: deploy/terraform/
    Arguments: 'plan -out=tfplan'
    InstallTerraform: true
    UseAzureSub: true
    ConnectedServiceNameARM: 'Microsoft Azure FHR infca (8f5caaee-a2d8-4d9a-a89c-f065af38e8c1)'
    ManageState: true
    SpecifyStorageAccount: true
    StorageAccountResourceGroup: 'CD_IaaS'
    StorageAccountRM: cdiaastfstate
    StorageContainerName: tfstate

- task: petergroenewegen.PeterGroenewegen-Xpirit-Vsts-Release-Terraform.Xpirit-Vsts-Release-Terraform.Terraform@2
  displayName: 'Terraform apply'
  inputs:
    TemplatePath: deploy/terraform/
    Arguments: apply -var "immutable_image_name=Hackathon-$(Build.BuildId)"'
    PlanPath: tfplan
    UseAzureSub: true
    ConnectedServiceNameARM: 'Microsoft Azure FHR infca (8f5caaee-a2d8-4d9a-a89c-f065af38e8c1)'
    ManageState: true
    SpecifyStorageAccount: true
    StorageAccountResourceGroup: 'CD_IaaS'
    StorageAccountRM: cdiaastfstate
    StorageContainerName: tfstate

